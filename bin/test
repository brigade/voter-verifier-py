#!/usr/bin/env bash
# To run this script locally (i.e. not via Docker):
# ELASTICSEARCH_HOSTS=http://[es_host]:9200/ ./bin/test
set -e

function cleanup() {
  docker stop $es_image
  docker rm -f $es_image >/dev/null
  docker rmi -f $test_image >/dev/null
}

function is-elasticsearch-up() {
  timeout 1 curl -s $(docker port $es_image 9200) | grep --silent tagline
}

function start-elasticsearch-container() {
  es_image=$(docker run --publish 9200 --detach dockerfile/elasticsearch)
  es_name=$(docker inspect -f '{{ .Name }}' $es_image)
  echo $es_image
  echo $es_name

  echo -n 'Waiting for ES'
  while ! is-elasticsearch-up; do
    echo -n '.'
    sleep 1
  done
  echo 'done'
}

echo "Building..."
test_image=$(uuidgen)
echo $test_image

trap cleanup EXIT
docker build -t $test_image .
start-elasticsearch-container

echo "----------------------------------------------------------------------"
echo "Testing:"

docker run \
  --rm \
  -e ELASTICSEARCH_HOSTS=http://elasticsearch:9200/ \
  --link $es_name:elasticsearch \
  $test_image \
  env/bin/nosetests
