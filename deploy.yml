# <% $deploy_variables = {} unless defined?($deploy_variables) %>
default: &default
  build:
    cache:
      - /app/env
    commands:
      - virtualenv env
      - source env/bin/activate
      - pip install -r requirements.txt --no-cache-dir
      - virtualenv --relocatable env

  deploy:
    nexus: { username: 'brigade-deployment', password: '8HBF5mMcfgkBSUp', group: 'verifier-deploy', tar_uid: 4060, tar_gid: 4060 }
    docker: { docker_tag_repo: 'brigade/verifier-deploy' }

  run:
    web: env/bin/gunicorn web:app -b 0.0.0.0:3000 --log-file=-
    test: source env/bin/activate && make test

  dependencies:
    - elasticsearch

  env: &default_env
    APP_DIRECTORY: '/mnt/mesos/sandbox'
    APP_UID: 4060 # pinned in cuisine/data_bags/users/verifier.json
    APP_GID: 4060 # pinned in cuisine/data_bags/users/verifier.json
    FLASK_ENV: 'production'
    STATSD_HOST: 'docker-host'
    SENTRY_DSN: 'https://c975cacd7f9148bd94ba4738fc039fb2:50e1b5fd696f444abf83c0984f6effe6@app.getsentry.com/55635'

  marathon:
    verifier:
      args: ['./env/bin/gunicorn', 'web:app', '-b', '0.0.0.0:3000', '--log-file=-']
      mem: 256
      cpus: 0.2
      instances: 2
      healthChecks:
        - protocol: HTTP
          intervalSeconds: 10
          timeoutSeconds: 10
          path: '/health'
          maxConsecutiveFailures: 0  # don't auto-kill tasks that fail health check
      container:
        type: 'DOCKER'
        docker:
          image: '<%= $deploy_variables[:docker_image] %>'
          network: 'BRIDGE'
          portMappings:
            - containerPort: 3000
              hostPort: 0
              protocol: 'tcp'
      uris:
        - '<%= $deploy_variables[:nexus_url] %>'

test:
  <<: *default

###############################################################################
# EDGE
###############################################################################
edge:
  <<: *default

  env:
    <<: *default_env
***REMOVED***

###############################################################################
# STAGING
###############################################################################
staging:
  <<: *default

  env:
    <<: *default_env
***REMOVED***

###############################################################################
# PRODUCTION
###############################################################################
production:
  <<: *default

  env:
    <<: *default_env
***REMOVED***
