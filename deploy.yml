# <% $deploy_variables = {} unless defined?($deploy_variables) %>
default: &default
  build:
    cache:
      - /app/env
    commands:
      - virtualenv env
      - source env/bin/activate
      - pip install -r requirements.txt --no-cache-dir

  deploy:
    nexus: { username: 'brigade-deployment', password: '8HBF5mMcfgkBSUp', group: 'verifier-deploy', tar_uid: 4060, tar_gid: 4060 }
***REMOVED***

  run:
    web: env/bin/gunicorn web:app -b 0.0.0.0:3000 --log-file=-
    test: source env/bin/activate && make test

  dependencies:
    - elasticsearch

  env: &default_env
    APP_DIRECTORY: '/mnt/mesos/sandbox'
    UID: 4060 # pinned in cuisine/data_bags/users/verifier.json
    GID: 4060 # pinned in cuisine/data_bags/users/verifier.json
    FLASK_ENV: 'production'
    STATSD_HOST: 'docker-host'
    SENTRY_DSN: 'https://c975cacd7f9148bd94ba4738fc039fb2:50e1b5fd696f444abf83c0984f6effe6@app.getsentry.com/55635'

  marathon:
    verifier:
      args: ['./env/bin/gunicorn', 'web:app', '-b', '0.0.0.0:3000', '--log-file=-']
      mem: 256
      cpus: 0.2
      instances: 2
      healthChecks:
        - protocol: HTTP
          intervalSeconds: 10
          timeoutSeconds: 10
          path: '/health'
          maxConsecutiveFailures: 0  # don't auto-kill tasks that fail health check
      container:
        type: 'DOCKER'
        docker:
          image: '<%= $deploy_variables[:docker_image] %>'
          network: 'BRIDGE'
          portMappings:
            - containerPort: 3000
              hostPort: 0
              protocol: 'tcp'
      uris:
        - '<%= $deploy_variables[:nexus_url] %>'

  chronos:
    verifier_reindex_all:
      # the "name" and "environmentVariables" keys are added at deploy-time
      epsilon: PT60S
      executor: ''
      executorFlags: ''
      retries: 2
***REMOVED***
      ownerName: ''
      async: false
      cpus: 1.0
      disk: 256.0
      mem: 1024.0
      softError: false
      dataProcessingJobType: false
      uris:
        - '<%= $deploy_variables[:nexus_url] %>'
      highPriority: false
      runAsUser: root
      # TODO: This command should be baked into the Docker image (as its
      # entrypoint), however a Chronos bug prevents us from using `shell: false`
      # and simply passing `arguments`. https://github.com/mesos/chronos/issues/567
      command: '/usr/local/bin/entrypoint'
      container:
        type: docker
        image: '<%= $deploy_variables[:docker_image] %>'
        network: BRIDGE
      scheduleTimeZone: UTC
      # TODO: Pass these arguments into the ./bin/run script. This is blocked
      # on a Chronos bug which adds the value of the arguments array to the
      # task ID which fails because slashes are invalid in task IDs.
      # https://github.com/mesos/chronos/issues/568
      arguments: ['bash', 'index_all.sh']
***REMOVED***
      schedule: R/2015-06-20T00:00:00.000Z/P1M # every month

test:
  <<: *default

###############################################################################
# EDGE
###############################################################################
edge:
  <<: *default

  env:
    <<: *default_env
***REMOVED***

###############################################################################
# STAGING
###############################################################################
staging:
  <<: *default

  env:
    <<: *default_env
***REMOVED***

###############################################################################
# PRODUCTION
###############################################################################
production:
  <<: *default

  env:
    <<: *default_env
***REMOVED***
